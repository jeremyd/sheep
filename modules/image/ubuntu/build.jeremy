# you need to make sure the following packages are installed 
# ubuntu-virt-server ubuntu-vm-builder kvm-pxe bridge-utils syslinux squashfs-tools genisoimage libvde0 vde2 kvm

required_inputs=(
  TYPE="type of image to build (options are base, psm)"
  DEST="build image in this destination directory"
) 

# parse command line inputs and ensure all required inputs are set
smart_parse $@
if ! verify_inputs required_inputs[@]; then 
  echo 
  ./help
  return 1
fi

release=natty
version=2
hypervisor=kvm

echo "SHEEPMOD = ${SHEEP_PARENT_MODULE_DIR}"

vmname=ubuntu-${TYPE}-${hypervisor}-${release}-${version}

# CUSTOM PARTITIONS
cat <<EOF > /tmp/vmbuilder.part
root 8000
swap 1000
/var 20000
EOF

if [ "$TYPE" = "psm" ]; then
declare -a build_steps=( "time sudo ubuntu-vm-builder $hypervisor $release \
  --execscript $(pwd)/setup-server \
  --tmpfs 2048 \
  --domain ermal14.com \
  --dest $DEST/${vmname} \
  --arch amd64 \
  --hostname psm \
  --mem 1024 \
  --user test \
  --pass test \
  --ip 192.168.20.11 \
  --mask 255.255.255.0 \
  --net 192.168.20.11 \
  --gw 192.168.20.1 \
  --dns 8.8.8.8 \
  --bcast 192.168.20.255 \
  --bridge br0 \
  --install-mirror http://mirror.anl.gov/ubuntu \
  --mirror http://mirror.anl.gov/ubuntu \
  --components main,universe,multiverse,restricted \
  --addpkg acpid \
  --addpkg vim \
  --addpkg curl \
  --addpkg wget \
  --addpkg emacs23-nox \
  --addpkg openssh-server \
  --addpkg avahi-daemon \
  --addpkg bash-completion \
  --addpkg rsync \
  --addpkg vlan \
  --debug"
  "cd $DEST"
  "mv $vmname/*.qcow2 $vmname.qcow2 "
  "rm -rf $vmname"
)
elif [ "$TYPE" = "base" ]; then
  if [[ "$OUTFILE" == "" ]]; then
    echo "ARGUMENT ERROR: please set --outfile for .tgz destination"
    exit 1
  fi
  declare -a build_steps=( 
    "sudo rm -rf $DEST"
    "sudo rm -rf $OUTFILE"
    "sudo mkdir -p $DEST"
    "sudo mount -t tmpfs -o size=4g tmpfs $DEST"
    "sudo time debootstrap --variant buildd --verbose --include=linux-image-server,linux-headers-generic,grub,acpid,vim,curl,wget,emacs23-nox,openssh-server,avahi-daemon,bash-completion,vlan natty $DEST http://mirror.anl.gov/ubuntu"
    "sudo $(pwd)/setup-base $DEST"
    "cd $DEST"
    "sudo time tar -czf $OUTFILE *"
    "cd .."
    "sudo umount $DEST"
  )
else
  echo "VM type not recognized.  Known types are psm, base"
  exit 1
fi

declare -a build_checks=(
  "test -f $DEST/etc/lsb_release"
)


declare -a spot_checks=(true)
build --build-steps build_steps[@] \
      --build-checks build_checks[@] \
      --spot-checks spot_checks[@] 

