# you need to make sure the following packages are installed 
# ubuntu-virt-server ubuntu-vm-builder kvm-pxe bridge-utils syslinux squashfs-tools genisoimage libvde0 vde2 kvm

required_inputs=(
  TYPE="type of image to build (options are base, psm)"
  DEST="build image in this destination directory"
) 

# parse command line inputs and ensure all required inputs are set
smart_parse $@
if ! verify_inputs required_inputs[@]; then 
  echo 
  ./help
  return 1
fi

release=natty
version=2
hypervisor=kvm

echo "SHEEPMOD = ${SHEEP_PARENT_MODULE_DIR}"

vmname=ubuntu-${TYPE}-${hypervisor}-${release}-${version}

if [ "$TYPE" = "psm" ]; then
declare -a build_steps=( "time sudo ubuntu-vm-builder $hypervisor $release \
  --execscript $(pwd)/setup-server \
  --tmpfs 2048 \
  --domain ermal14.com \
  --dest $DEST/${vmname} \
  --arch amd64 \
  --hostname psm \
  --mem 1024 \
  --user test \
  --pass test \
  --ip 192.168.20.11 \
  --mask 255.255.255.0 \
  --net 192.168.20.11 \
  --gw 192.168.20.1 \
  --dns 8.8.8.8 \
  --bcast 192.168.20.255 \
  --bridge br0 \
  --install-mirror http://mirror.anl.gov/ubuntu \
  --mirror http://mirror.anl.gov/ubuntu \
  --components main,universe,multiverse,restricted \
  --addpkg acpid \
  --addpkg vim \
  --addpkg curl \
  --addpkg wget \
  --addpkg emacs23-nox \
  --addpkg openssh-server \
  --addpkg avahi-daemon \
  --addpkg vlan \
  --debug"
  "cd $DEST"
  "mv $vmname/*.qcow2 $vmname.qcow2 "
  "rm -rf $vmname"
)
elif [ "$TYPE" = "base" ]; then
declare -a build_steps=( "time sudo ubuntu-vm-builder $hypervisor $release \
  --execscript $(pwd)/setup-base \
  --tmpfs 2048 \
  --domain ermal14.com \
  --dest $DEST/${vmname} \
  --arch amd64 \
  --hostname basebox \
  --mem 1024 \
  --user test \
  --pass test \
  --dns 8.8.8.8 \
  --install-mirror http://mirror.anl.gov/ubuntu \
  --mirror http://mirror.anl.gov/ubuntu \
  --components main,universe,multiverse,restricted \
  --addpkg acpid \
  --addpkg vim \
  --addpkg curl \
  --addpkg wget \
  --addpkg emacs23-nox \
  --addpkg openssh-server \
  --addpkg avahi-daemon \
  --addpkg vlan \
  --debug"
  "cd $DEST"
  "mv $vmname/*.qcow2 $vmname.qcow2 "
  "rm -rf $vmname"
)
else
  echo "VM type not recognized.  Known types are psm, base"
  exit 1
fi

declare -a build_checks=(
  "test -f $DEST/$vmname.qcow2"
)


declare -a spot_checks=(true)
build --build-steps build_steps[@] \
      --build-checks build_checks[@] \
      --spot-checks spot_checks[@] 

